require 'technical-analysis'
require 'spec_helper'

describe 'Indicators' do
  describe "SR" do
    input_data = SpecHelper.get_test_data(:high, :low, :close)

    describe 'Stochastic Oscillator' do
      it 'Calculates SR (14 day)' do
        output = TechnicalAnalysis::Sr.calculate(input_data, period: 14)

        expected_output = [
          {:date=>"2018/10/26", :value=>26.622073578595405},
          {:date=>"2018/10/29", :value=>30.355380059230054},
          {:date=>"2018/10/30", :value=>39.746416758544726},
          {:date=>"2018/10/31", :value=>70.39691289966935},
          {:date=>"2018/11/01", :value=>88.91951488423378},
          {:date=>"2018/11/02", :value=>10.904255319148854},
          {:date=>"2018/11/05", :value=>13.123561013046874},
          {:date=>"2018/11/06", :value=>21.48887183422879},
          {:date=>"2018/11/07", :value=>45.203376822716805},
          {:date=>"2018/11/08", :value=>39.60092095165012},
          {:date=>"2018/11/09", :value=>24.174980813507332},
          {:date=>"2018/11/12", :value=>1.2483574244415094},
          {:date=>"2018/11/13", :value=>2.5231398354572394},
          {:date=>"2018/11/14", :value=>2.388141641504267},
          {:date=>"2018/11/15", :value=>15.04254735108424},
          {:date=>"2018/11/16", :value=>20.86192698325554},
          {:date=>"2018/11/19", :value=>2.32807064490234},
          {:date=>"2018/11/20", :value=>3.137673425827104},
          {:date=>"2018/11/21", :value=>3.329837441006842},
          {:date=>"2018/11/23", :value=>0.49973698053655363},
          {:date=>"2018/11/26", :value=>10.938283993978956},
          {:date=>"2018/11/27", :value=>9.984947315604659},
          {:date=>"2018/11/28", :value=>26.79377822378325},
          {:date=>"2018/11/29", :value=>25.986013986014044},
          {:date=>"2018/11/30", :value=>28.117607299763502},
          {:date=>"2018/12/03", :value=>54.0861812778603},
          {:date=>"2018/12/04", :value=>26.022380056253674},
          {:date=>"2018/12/06", :value=>18.049737955037553},
          {:date=>"2018/12/07", :value=>0.712424304917594},
          {:date=>"2018/12/10", :value=>22.908293752283477},
          {:date=>"2018/12/11", :value=>24.525682554372914},
          {:date=>"2018/12/12", :value=>26.700601573345605},
          {:date=>"2018/12/13", :value=>35.26145303100408},
          {:date=>"2018/12/14", :value=>9.94909763998139},
          {:date=>"2018/12/17", :value=>5.447996398018944},
          {:date=>"2018/12/18", :value=>15.038271049077},
          {:date=>"2018/12/19", :value=>6.963249516440942},
          {:date=>"2018/12/20", :value=>5.161943319838063},
          {:date=>"2018/12/21", :value=>3.1152647975077716},
          {:date=>"2018/12/24", :value=>0.6703929340585003},
          {:date=>"2018/12/26", :value=>37.531039375665074},
          {:date=>"2018/12/27", :value=>34.2652329749104},
          {:date=>"2018/12/28", :value=>37.105465742879105},
          {:date=>"2018/12/31", :value=>42.917628945342614},
          {:date=>"2019/01/02", :value=>43.61046959199379},
          {:date=>"2019/01/03", :value=>0.6215243702976702},
          {:date=>"2019/01/04", :value=>23.1166912850812},
          {:date=>"2019/01/07", :value=>22.50474383301711},
          {:date=>"2019/01/08", :value=>34.27340383862123},
          {:date=>"2019/01/09", :value=>44.44007858546172}
        ]

        expect(output).to eq(expected_output)
      end

      it "Throws exception if not enough data" do
        expect {TechnicalAnalysis::Sr.calculate(input_data, period: input_data.size+1)}.to raise_exception(Validation::ValidationError)
      end
    end
  end
end
